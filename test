a!localVariables(
  local!applicationAndHipMapData: {
    a!map(
      fieldName: "Email",
      cardChoices: {
        a!map(id: "application/email", primaryText: "constance.wu@gmail.com"),
        a!map(id: "slip_entity/email", primaryText: "constance.wu@gmail.com")
      },
      selectedChoice: "",
      verificationIsNeeded: true()
    ),
    a!map(
      fieldName: "Address",
      cardChoices: {
        a!map(id: "application/address", primaryText: "DrNo 123 Address"),
        a!map(id: "slip_entity/address", primaryText: "456 Address")
      },
      selectedChoice: "",
      verificationIsNeeded: true()
    )
  },
  
  /* State variables for editing functionality */
  local!editingIndex: null,
  local!editingValue: "",
  
  a!sectionLayout(
    contents: {
      a!richTextDisplayField(
        label: "Review and update the following Fields:"
      ),
      a!columnsLayout(
        columns: {
          a!columnLayout(contents: {}),
          a!columnLayout(
            contents: {
              a!columnsLayout(
                columns: {
                  a!columnLayout(
                    contents: {
                      a!richTextDisplayField(
                        value: {
                          a!richTextItem(
                            text: "Application Field",
                            style: "STRONG"
                          )
                        }
                      )
                    }
                  ),
                  a!columnLayout(
                    contents: {
                      a!richTextDisplayField(
                        value: {
                          a!richTextItem(
                            text: "ALIP Field",
                            style: "STRONG"
                          )
                        }
                      )
                    }
                  )
                }
              )
            },
            width: "MEDIUM_PLUS"
          ),
          a!columnLayout(
            width: "EXTRA_NARROW"
          ),
          a!columnLayout(
            contents: {
              a!richTextDisplayField(
                value: {
                  a!richTextItem(
                    text: "Is Verification Needed",
                    style: "STRONG"
                  )
                }
              )
            }
          )
        }
      ),
      
      /* Main forEach loop with editing functionality */
      a!forEach(
        items: local!applicationAndHipMapData,
        expression: a!localVariables(
          local!disabled: true,
          a!columnsLayout(
            columns: {
              a!columnLayout(
                contents: {
                  /* Show editable field or display field based on editing state */
                  if(
                    local!editingIndex = fv!index,
                    /* Editing mode - show text field */
                    a!textField(
                      label: "Edit Application Field",
                      labelPosition: "COLLAPSED",
                      value: local!editingValue,
                      saveInto: local!editingValue,
                      placeholder: "Enter new field name",
                      required: true
                    ),
                    /* Display mode - show current field name */
                    a!richTextDisplayField(
                      value: {
                        a!richTextItem(
                          text: index(fv!item, "fieldName", {}),
                          style: "STRONG",
                          color: cons!NW_COLOR_SECONDARY
                        )
                      }
                    )
                  )
                }
              ),
              a!columnLayout(
                contents: {
                  a!cardChoiceField(
                    label: "Application Status Choices",
                    labelPosition: "COLLAPSED",
                    align: "START",
                    data: index(fv!item, "cardChoices", {}),
                    cardTemplate: a!cardTemplateBarTextStacked(
                      id: fv!data.id,
                      primaryText: fv!data.primaryText
                    ),
                    value: index(fv!item, "selectedChoice", {}),
                    saveInto: fv!item.selectedChoice,
                    maxSelections: 1,
                    required: true
                  )
                },
                width: "MEDIUM_PLUS"
              ),
              a!columnLayout(
                contents: {
                  if(
                    local!editingIndex = fv!index,
                    /* Show save/cancel buttons when editing */
                    a!buttonArrayLayout(
                      buttons: {
                        a!buttonWidget(
                          label: "Save",
                          style: "PRIMARY",
                          size: "SMALL",
                          saveInto: {
                            /* Update the field name with new value */
                            a!save(
                              local!applicationAndHipMapData[fv!index].fieldName,
                              local!editingValue
                            ),
                            /* Clear editing state */
                            a!save(local!editingIndex, null),
                            a!save(local!editingValue, "")
                          }
                        ),
                        a!buttonWidget(
                          label: "Cancel",
                          style: "SECONDARY",
                          size: "SMALL",
                          saveInto: {
                            a!save(local!editingIndex, null),
                            a!save(local!editingValue, "")
                          }
                        )
                      },
                      align: "START"
                    ),
                    /* Show edit button when not editing */
                    a!richTextDisplayField(
                      value: a!richTextIcon(
                        icon: "edit",
                        caption: "Edit " & fv!item.fieldName & " Application Value",
                        link: a!dynamicLink(
                          value: fv!index,
                          saveInto: {
                            a!save(local!editingIndex, fv!index),
                            a!save(local!editingValue, fv!item.fieldName)
                          }
                        )
                      ),
                      linkStyle: "INLINE"
                    )
                  )
                },
                width: "EXTRA_NARROW"
              ),
              a!columnLayout(
                contents: {
                  a!dropdownField(
                    choiceLabels: cons!NW_TEXT_CHOICES_YES_OR_NO,
                    choiceValues: cons!NW_TEXT_CHOICE_VALUES_TRUE_OR_FALSE,
                    placeholder: "Select",
                    value: toboolean(fv!item.verificationIsNeeded),
                    saveInto: fv!item.verificationIsNeeded,
                    labelPosition: "COLLAPSED"
                  )
                }
              )
            }
          )
        ),
        showWhen: ri!showWhen
      )
    }
  )
)
